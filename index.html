<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>éš¨æ©ŸæŒ‘é¤å»³</title>
<style>
    body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 20px;
    }
    h2 { text-align: center; color:#333; }
    input, select {
        width: 90%;
        max-width: 400px;
        font-size: 18px;
        padding: 12px;
        margin: 6px 0;
        border-radius: 5px;
        border: 1px solid #ccc;
    }
    button {
        width: 90%;
        max-width: 400px;
        padding: 12px;
        margin-top: 12px;
        background: #4CAF50;
        color: white;
        font-size: 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    button:hover { background-color: #45a049; }
    #loading { color:#666; margin-top:15px; }
    #result {
        margin-top: 25px;
        font-size: 22px;
        font-weight: bold;
        color: #e91e63;
        text-align: center;
        min-height: 120px;
    }
    #map { width:0; height:0; }
</style>
</head>

<body>

<h2>å¾æŒ‡å®šå€åŸŸéš¨æ©Ÿé¸ä¸€å®¶é¤å»³</h2>

<input id="locationInput" type="text" placeholder="è¼¸å…¥åœ°é»ï¼Œä¾‹å¦‚ï¼šå°åŒ—å¸‚ ä¿¡ç¾©å€">
<input id="radiusInput" type="number" placeholder="æœå°‹åŠå¾‘ï¼ˆå…¬å°ºï¼Œå¯ç•™ç©ºï¼‰">
<input id="keywordInput" type="text" placeholder="é—œéµå­—ï¼ˆå°åƒã€ä¾¿ç•¶ã€å¤œå¸‚ï¼Œå¯ç•™ç©ºï¼‰">

<select id="typeSelect">
    <option value="restaurant">éš¨æ©Ÿé¤å»³</option>
    <option value="cafe">å’–å•¡å»³</option>
    <option value="fast_food">é€Ÿé£Ÿåº—</option>
    <option value="bar">é…’å§</option>
</select>

<button onclick="search()">é–‹å§‹æŠ½é¤å»³</button>

<div id="loading"></div>
<div id="result"></div>
<div id="map"></div>

<script>
let map;
let allResults = [];
let animationInterval = null;
let hasPicked = false; // ç¢ºä¿ pickRandomRestaurant() åªæœƒåŸ·è¡Œä¸€æ¬¡

function search() {
    hasPicked = false; // é‡ç½®é˜²é‡è¤‡æ——æ¨™
    allResults = [];   // æ¸…ç©ºå‰ä¸€æ¬¡æœå°‹çµæœ

    const locationName = document.getElementById("locationInput").value;
    let radius = parseInt(document.getElementById("radiusInput").value);
    const type = document.getElementById("typeSelect").value;
    const keyword = document.getElementById("keywordInput").value.trim();

    if (!locationName) {
        alert("è«‹è¼¸å…¥åœ°é»ï¼");
        return;
    }
    if (!radius || radius <= 0) radius = 1000; // é è¨­ 1000 å…¬å°º

    document.getElementById("loading").textContent = "æ­£åœ¨å–å¾—åº§æ¨™...";
    document.getElementById("result").textContent = "";

    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: locationName }, function(results, status) {

        if (status !== "OK") {
            document.getElementById("loading").textContent = "ç„¡æ³•å®šä½æ­¤åœ°å€ï¼š" + status;
            return;
        }

        const location = results[0].geometry.location;
        map = new google.maps.Map(document.getElementById("map"), {
            center: location, zoom: 15
        });

        document.getElementById("loading").textContent = "æ­£åœ¨æœå°‹é¤å»³...";

        const service = new google.maps.places.PlacesService(map);

        function nearbySearchPage(pageToken = null) {
            const request = {
                location: location,
                radius: radius,
                type: type
            };

            if (keyword) request.keyword = keyword;
            if (pageToken) request.pageToken = pageToken;

            service.nearbySearch(request, function(results, status, pagination) {

                if (status === "OK" && results.length) {
                    allResults = allResults.concat(results);

                    if (pagination && pagination.hasNextPage) {
                        setTimeout(() => {
                            nearbySearchPage(pagination.nextPage());
                        }, 1500);
                    } else {
                        pickRandomRestaurant();
                    }

                } else {
                    if (!allResults.length) {
                        document.getElementById("loading").textContent = "";
                        document.getElementById("result").textContent = "æ‰¾ä¸åˆ°é¤å»³";
                    } else {
                        pickRandomRestaurant();
                    }
                }
            });
        }

        nearbySearchPage();
    });
}

function pickRandomRestaurant() {

    // é˜²æ­¢è¢«å‘¼å«å…©æ¬¡ä»¥ä¸Š
    if (hasPicked) return;
    hasPicked = true;

    const resultDiv = document.getElementById("result");
    document.getElementById("loading").textContent = "";

    if (!allResults.length) {
        resultDiv.textContent = "æ‰¾ä¸åˆ°é¤å»³";
        return;
    }

    const names = allResults.map(r => r.name);

    // å¦‚æœä¹‹å‰æœ‰å‹•ç•«ï¼Œå…ˆæ¸…æ‰
    if (animationInterval) {
        clearInterval(animationInterval);
        animationInterval = null;
    }

    let count = 0;
    const maxCount = 20;  // é–ƒçˆæ¬¡æ•¸

    animationInterval = setInterval(() => {
        const randomIndex = Math.floor(Math.random() * names.length);
        resultDiv.textContent = names[randomIndex];
        count++;

        if (count >= maxCount) {
            clearInterval(animationInterval);
            animationInterval = null;

            const finalPick = allResults[Math.floor(Math.random() * allResults.length)];
            resultDiv.innerHTML = `
                ğŸ‰ ä»Šå¤©åƒï¼š<br><br>
                <span style="font-size:28px;">${finalPick.name}</span><br><br>
                â­ è©•åˆ†ï¼š${finalPick.rating || "ç„¡"}<br>
                ğŸ—ºï¸ åœ°å€ï¼š${finalPick.vicinity || "ç„¡è³‡æ–™"}<br><br>
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(finalPick.name)}"
                   target="_blank">æ‰“é–‹ Google åœ°åœ–</a>
            `;
        }
    }, 100);
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA3pTso7fz7uUkB4jvie9X3hy__fSmYwLw&libraries=places"></script>

</body>
</html>
